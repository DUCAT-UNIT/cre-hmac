groups:
  - name: gateway_alerts
    interval: 30s
    rules:
      # Service availability
      - alert: GatewayDown
        expr: up{job="gateway"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Gateway server is down"
          description: "Gateway {{ $labels.instance }} has been down for more than 1 minute."

      # High error rate
      - alert: GatewayHighErrorRate
        expr: rate(gateway_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Gateway error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Capacity warnings
      - alert: GatewayNearCapacity
        expr: gateway_pending_requests / 1000 > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Gateway near capacity"
          description: "Gateway is at {{ $value | humanizePercentage }} capacity"

      - alert: GatewayAtCapacity
        expr: gateway_pending_requests / 1000 >= 1.0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Gateway at capacity limit"
          description: "Gateway has reached maximum capacity ({{ $value }} pending requests)"

      # Timeout alerts
      - alert: GatewayHighTimeouts
        expr: rate(gateway_request_timeouts_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High timeout rate"
          description: "Gateway timeout rate is {{ $value }} requests/sec (threshold: 0.1/sec)"

      # Webhook issues
      - alert: GatewayWebhookMismatch
        expr: |
          sum(rate(gateway_webhooks_received_total{matched="no_match"}[5m])) /
          sum(rate(gateway_webhooks_received_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High webhook mismatch rate"
          description: "{{ $value | humanizePercentage }} of webhooks are not matching pending requests"

      # Dependency health
      - alert: CREGatewayDown
        expr: gateway_dependency_status{dependency="cre_gateway"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "CRE Gateway unreachable"
          description: "Cannot connect to CRE gateway"

      - alert: CREGatewayDegraded
        expr: gateway_dependency_status{dependency="cre_gateway"} == 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CRE Gateway degraded"
          description: "CRE gateway is responding slowly"

      # Readiness checks
      - alert: GatewayNotReady
        expr: rate(gateway_health_checks_total{type="readiness",status="unhealthy"}[5m]) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Gateway failing readiness checks"
          description: "Gateway is failing readiness checks"

      # Workflow triggers
      - alert: WorkflowTriggerFailures
        expr: rate(gateway_workflow_triggers_total{status="error"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "CRE workflow trigger failures"
          description: "Gateway is unable to trigger CRE workflows"

      # Request latency
      - alert: GatewayHighLatency
        expr: histogram_quantile(0.95, rate(gateway_http_request_duration_seconds_bucket[5m])) > 65
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency"
          description: "P95 latency is {{ $value }}s (threshold: 65s, normal: ~60s for blocking requests)"
